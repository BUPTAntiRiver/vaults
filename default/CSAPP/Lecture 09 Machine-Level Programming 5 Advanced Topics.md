# Memory Layout 内存布局

内存就是一大长条字节。
分为几块功能：

- **Stack 栈** 运行时使用，存储局部变量等等
- **Heap** 堆 根据需要动态分配，当调用 `malloc(), new()` 时
- **Data** 静态分配数据，例如全局变量，字符串等等
- **Text / Shared Libraries** 可执行的机器指令，只读

# Buffer Overflow 缓存溢出

## Buffer Overflow 攻击

当超出分配的数组内存空间时发生。
可以通过利用 Buffer Overflow 来实现 code injection。将攻击方想要执行的代码编码后输入，再不断输入直到 Buffer Overflow，然后再输入攻击方想要执行的代码的起始地址，程序就会将这个地址视为函数的返回地址，跳转到攻击方想要执行的代码。

## 如何防范？

1. 随机化栈地址，每次运行中不断改变栈地址。
2. 将执行代码存放在难以修改的类似于 text 区，只读区域。
3. Stack Canaries 金丝雀值，当金丝雀值被修改时表明出现问题。

## ROP 攻击

常规的 Buffer Overflow 攻击在防范手段下难以存活，因此使用 ROP 攻击。
ROP 攻击通过利用程序中已有的代码段运作，截取**返回**语句 `ret` 以及之前的一段代码，实现想要的功能，然后将许多这样的代码块 **Gadgets** 组合起来，在输入时**显式地输入这些代码块的地址**，这些地址会作为返回的地址跳转，从而不断运行 Gadgets 中的代码，实现想要实现的功能。

# Union 空间分配

根据最大的元素进行分配，一次只使用一份空间，不同元素在比它大的元素”身上“使用空间。

## 总结 C 中的复合类型

### Array 数组

- 一段连续的内存分配
- 满足所有元素的对齐要求
- 一个**指向首个元素的指针**
- **没有边界检查**

### Structures 结构体

- 根据声明的顺序分配内存
- 在中间和末尾进行填充从而**满足对齐**

### Unions

- **重叠**分配内存
- 规避类型检查的方法
